name: Build Magisk Module

on:
  push:
    branches:
      - '*'
    paths:
      - 'module.prop'
      - 'META-INF/**'
      - 'system/**'
      - 'customize.sh'
      - 'service.sh'
      - 'post-fs-data.sh'
      - 'uninstall.sh'
      - 'B.sh'
      - 'U.sh'
      - 'action.sh'
      - 'cs.sh'
      - 'hcccccccc'
      - 'bcccccccc'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get module info
        id: module_info
        run: |
          MODULE_ID=$(grep -oP 'id=\K.*' module.prop)
          MODULE_NAME=$(grep -oP 'name=\K.*' module.prop)
          MODULE_VERSION=$(grep -oP 'version=\K.*' module.prop)
          MODULE_VERSIONCODE=$(grep -oP 'versionCode=\K.*' module.prop)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          REPO_NAME=${{ github.repository }}
          
          echo "module_id=$MODULE_ID" >> $GITHUB_OUTPUT
          echo "module_name=$MODULE_NAME" >> $GITHUB_OUTPUT
          echo "module_version=$MODULE_VERSION" >> $GITHUB_OUTPUT
          echo "module_versioncode=$MODULE_VERSIONCODE" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Update updateJson in module.prop
        run: |
          REPO_NAME=${{ steps.module_info.outputs.repo_name }}
          sed -i "s|updateJson=.*|updateJson=https://raw.githubusercontent.com/${REPO_NAME}/main/update.json|g" module.prop

      - name: Build module zip
        id: build
        run: |
          MODULE_ID=${{ steps.module_info.outputs.module_id }}
          MODULE_VERSION=${{ steps.module_info.outputs.module_version }}
          BRANCH_NAME=${{ steps.module_info.outputs.branch_name }}
          
          ZIP_NAME="${MODULE_ID}-${MODULE_VERSION}.zip"
          
          # Create zip file
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*" "README.md" "update.json"
          
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.module_info.outputs.module_version }}
          name: ${{ steps.module_info.outputs.module_name }} v${{ steps.module_info.outputs.module_version }}
          files: ${{ steps.build.outputs.zip_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update update.json
        run: |
          MODULE_VERSION=${{ steps.module_info.outputs.module_version }}
          MODULE_VERSIONCODE=${{ steps.module_info.outputs.module_versioncode }}
          REPO_NAME=${{ steps.module_info.outputs.repo_name }}
          
          # Create or update update.json
          cat > update.json << EOF
          {
            "version": "${MODULE_VERSION}",
            "versionCode": ${MODULE_VERSIONCODE},
            "zipUrl": "https://github.com/${REPO_NAME}/releases/download/v${MODULE_VERSION}/${{ steps.build.outputs.zip_name }}",
            "changelog": "https://github.com/${REPO_NAME}/releases/tag/v${MODULE_VERSION}"
          }
          EOF
          
          # Commit and push update.json to main branch
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Always push update.json to main branch regardless of current branch
          if [ "${{ steps.module_info.outputs.branch_name }}" == "main" ]; then
            git add update.json module.prop
            git commit -m "Update module to v${MODULE_VERSION} (${MODULE_VERSIONCODE})"
            git push origin main
          else
            # If we're not on main branch, we need to push to main separately
            git checkout -b temp-branch
            git add update.json
            git commit -m "Update module to v${MODULE_VERSION} (${MODULE_VERSIONCODE})"
            git push origin temp-branch:main -f
          fi
